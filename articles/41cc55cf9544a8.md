---
title: "gatekeeper ã§ ValidatingAdmissionPolicy ã‚’æ‰±ã†"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Kubernetes", "Gatekeeper"]
published: true
---

# Validating Admission Policy ã«ã¤ã„ã¦

[Kubernetes 1.30 ã§ Validating Admission Policy ãŒ GA](https://kubernetes.io/blog/2024/04/24/validating-admission-policy-ga/) ã«ãªã‚Šã¾ã—ãŸã€‚

Kubernetes ã«ã¯ãƒªã‚½ãƒ¼ã‚¹ä½œæˆå‰ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‹ã‘ã‚‹æ–¹æ³•ã¨ã—ã¦ Validating Admission Webhook ã‚’ä½¿ã†æ–¹æ³•ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ãŒã€Validating Admission Policy (ä»¥å¾Œ VAP) ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å¤–éƒ¨ã® webhook ã®ã‚µãƒ¼ãƒãƒ¼ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚„è¨¼æ˜æ›¸ã®è¨­å®šã‚’è¡Œã†ã“ã¨ãªã kube-apiserver å†…éƒ¨ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Œçµã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã®è¾ºã‚Šã®åˆ©ç‚¹ã¯ä»–ã®æ–¹ãŒæ›¸ã‹ã‚ŒãŸè¨˜äº‹ã§ã‚‚è¨˜è¼‰ã•ã‚Œã¦ã„ãŸã®ã§ã“ã‚Œä»¥ä¸Šã¯å‰²æ„›ã—ã¾ã™ã€‚

ç§ã®æ‰€å±ã™ã‚‹ãƒãƒ¼ãƒ ã§ã¯ Validating Admission Policy ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«èª²ã—ãŸã„ Policy ãŒã‚ã£ãŸã®ã§ã“ã®æ©Ÿèƒ½ã®æ¤œè¨¼ã‚’è¡Œã£ã¦ã„ã¾ã—ãŸã€‚

ã„ã–ã‚¯ãƒ©ã‚¹ã‚¿ã«é©ç”¨ã—ã‚ˆã†ã¨æ€ã£ãŸéš›ã«ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã‹ã‚‰ã€Œãƒ†ã‚¹ãƒˆãªã©ã®è«¸ã€…ã‚’è€ƒãˆã‚‹ã®ã§ã‚ã‚Œã° Gatekeeper ã®æ©Ÿèƒ½ã‚’ä½¿ãˆãªã„ã‹è©¦ã—ãŸã„ã€ã¨ã„ã†è©±ã‚’å—ã‘ã¦ã€æœ€çµ‚çš„ã«ãã¡ã‚‰ã‚’ä½¿ç”¨ã™ã‚‹å½¢ã«è½ã¡ç€ã„ãŸã®ã§ç´¹ä»‹ã—ã¾ã™ã€‚

## Gatekeeper ã® VAP Integration

[Gatekeeper ã¯ v3.18 ã‹ã‚‰ VAP ã® CEL è¨˜æ³•ã«å¯¾å¿œã—ã¦ã„ã¾ã™](https://open-policy-agent.github.io/gatekeeper/website/docs/validating-admission-policy/)ã€‚

è©³ç´°ã¯ [gatekeeper ã®ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ demo](https://github.com/open-policy-agent/gatekeeper/tree/master/demo/scoped-enforcement-actions) ã‚’è¦‹ã‚‹ã®ãŒè‰¯ã„ã®ã§ã™ãŒã€ConstraintTemplate ã® generateVAP(`spec.targets[].code[].source.generateVAP`) ã‚’ true ã«è¨­å®šã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ validatinons(`spec.targets[].code[].source.validations`) ã«æ›¸ã‹ã‚ŒãŸ CEL å¼ã‚’ã‚‚ã¨ã«ã—ãŸ VAP ã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yaml: k8srequiredlabels_template_uservap.yaml
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        openAPIV3Schema:
          type: object
          properties:
            message:
              type: string
            labels:
              type: array
              items:
                type: object
                properties:
                  key:
                    type: string
                  allowedRegex:
                    type: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      code:
        - engine: K8sNativeValidation
          source:
            generateVAP: true
            validations:
            - expression: '(has(variables.anyObject.metadata) && variables.params.labels.all(entry, has(variables.anyObject.metadata.labels) && entry.key in variables.anyObject.metadata.labels))'
              messageExpression: '"missing required label, requires all of: " + variables.params.labels.map(entry, entry.key).join(", ")'
            - expression: '(has(variables.anyObject.metadata) && variables.params.labels.all(entry, has(variables.anyObject.metadata.labels) && entry.key in variables.anyObject.metadata.labels && string(variables.anyObject.metadata.labels[entry.key]).matches(string(entry.allowedRegex))))'
              message: "regex mismatch"
```

ã¾ãŸ VAP ã‚’é©ç”¨ã™ã‚‹å ´åˆã¯ Validating Admission Policy Binding (ä»¥å¾Œ VAPB) ã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã®ãŸã‚ã«ã¯ä¸Šè¨˜ã® ConstraintTemplates ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸ CRD(`K8sRequiredLabels`) ã§ã‚ã‚‹ Constraint Resource ã§

enforcementAction(`spec.enforcementAction`) ã‚’ scoped ã«ã— scopedEnforcementActions(`spec.scopedEnforcementActions`) ã« `vap.k8s.io` ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```yaml: owner_must_be_provided_uservap.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: all-must-have-owner
spec:
  enforcementAction: scoped
  scopedEnforcementActions:
  - action: deny
    enforcementPoints:
    - name: validation.gatekeeper.sh
    - name: audit.gatekeeper.sh
  - action: warn
    enforcementPoints:
    - name: vap.k8s.io
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
  parameters:
    message: "All namespaces must have an `owner` label that points to your company username"
    labels:
      - key: owner
        allowedRegex: "^[a-zA-Z]+.agilebank.demo$"
```

ã“ã‚Œã§ VAP ã¨ VAPB ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

## gator ã‚’ç”¨ã„ã¦ VAP ã¨ VAPB ã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã†

Gatekeeper ã§ã¯ [gator](https://open-policy-agent.github.io/gatekeeper/website/docs/gator/) ã¨å‘¼ã°ã‚Œã‚‹ CLI ãƒ„ãƒ¼ãƒ«ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€å®Ÿéš›ã®ã‚¯ãƒ©ã‚¹ã‚¿ã«é©ç”¨ã›ãšã¨ã‚‚ CLI ã§å‹•ä½œã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
gator ã§ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ãŸã‚ã«ã¯ [Suite ã® CRD](https://open-policy-agent.github.io/gatekeeper/website/docs/gator/#suites) ã«ãã£ã¦ Constraint ã¨ Template ãã—ã¦ã€ãã‚Œãã‚Œã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ä½¿ç”¨ã™ã‚‹ k8s ã®ãƒªã‚½ãƒ¼ã‚¹ã® manifest ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ã¯ gatekeeper ãƒãƒ¼ãƒ ã®ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ [demo](https://github.com/open-policy-agent/gatekeeper/blob/master/demo/scoped-enforcement-actions/k8srequiredlabels_template_usevap.yaml) ã« suite ã¨ãƒ†ã‚¹ãƒˆç”¨ã® manifest ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

ã¾ãš gator ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯ Constraint ã® enforcementPoints(`spec.scopedEnforcementActions[].enforcementPoints`) ã« `- name: gator.gatekeeper.sh` ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€ã“ã®è¨˜è¿°ãŒãªã„ã¨ gator ã®å¯¾è±¡ã¨ã—ã¦æŒ‡å®šã—ãŸ Constraint ãŒèªè­˜ã•ã‚Œã¾ã›ã‚“ã€‚

```yaml: demo/scoped-enforcement-actions/owner_must_be_provided.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sRequiredLabels
metadata:
  name: all-must-have-owner
spec:
  enforcementAction: scoped
  scopedEnforcementActions:
  - action: deny
    enforcementPoints:
    - name: gator.gatekeeper.sh # gator ã‚’è¿½åŠ ã™ã‚‹
    - name: validation.gatekeeper.sh
    - name: audit.gatekeeper.sh
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Namespace"]
  parameters:
    message: "All namespaces must have an `owner` label that points to your company username"
    labels:
      - key: owner
        allowedRegex: "^[a-zA-Z]+.agilebank.demo$"
```

demo ã® VAP / VAPB ã¯ Namespace ãŒç‰¹å®šã® label ã‚’æ‰€æŒã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚
error-ns ã§ã¯ label ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

```yaml: demo/scoped-enforcement-actions/suite.yaml
apiVersion: test.gatekeeper.sh/v1alpha1
kind: Suite
metadata:
  name: all-must-have-owner
tests:
  - name: all-must-have-owner
    template: k8srequiredlabels_template_usevap.yaml
    constraint: owner_must_be_provided_usevap.yaml
    cases:
      - name: success-ns
        object: testdata/success-ns.yaml
        assertions:
          - violations: 0
      - name: error-ns
        object: testdata/error-ns.yaml
        assertions:
          - violations: 2
```

```yaml: demo/scoped-enforcement-actions/testdata/error-ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: error
```

```yaml: demo/scoped-enforcement-actions/testdata/success-ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: success
  labels:
    "owner": "test.agilebank.demo"
```

ãã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãª gator ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨å®šç¾©ã—ãŸ Suite ã«ãã£ã¦å®Ÿè¡Œã•ã‚Œã€æ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ gator verify -v demo/scoped-enforcement-actions/suite.yaml
=== RUN   all-must-have-owner
    === RUN   allowed-ns
    --- PASS: allowed-ns        (0.007s)
    === RUN   error-ns
    --- PASS: error-ns  (0.004s)
--- PASS: all-must-have-owner   (0.026s)
ok      demo/scoped-enforcement-actions/suite.yaml 0.026s
PASS
```

å®Ÿéš›ã« CI ãªã©ã§å®Ÿè¡Œã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãª make ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ `${PWD}/target` ã«å¯¾ã—ã¦ gator ã§ã® test ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```Makefile
GATOR_VERSION ?= v3.18.2
GATOR_CMD ?= docker run -v ${PWD}/target:/target --rm ghcr.io/open-policy-agent/gator:$(GATOR_VERSION)
GATOR_TARGET ?= /target/...

vap-test:
	$(GATOR_CMD) verify -v $(GATOR_TARGET)
```

## ã¾ã¨ã‚

ä»Šå›ã¯ VAP / VAPB ã‚’ gatekeeper ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦å®šç¾©ã€ä½œæˆã—ã€gator ã¨ã„ã† CLI ã§ãƒ†ã‚¹ãƒˆã‚’è¡Œã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ãŸã  manifest ã‚’å®šç¾©ã—ã¦ã‚¯ãƒ©ã‚¹ã‚¿ã«åæ˜ ã—ã€ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã§ãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ã‚‚è‰¯ã„ã§ã™ãŒã€ gator ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã‚ˆã‚Šç°¡æ½”ã«ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒã§ã CI ã§ã‚‚ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼
