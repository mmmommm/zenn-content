---
title: "k8s.io/utils/ptr ã®ä½¿ã„é“"
emoji: "ğŸŒŠ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go", "Kubernetes"]
published: true
---

Go ã§ Pointer ã‚’æ“ä½œã—ãŸã„å ´åˆã« "k8s.io/utils/ptr" ãŒä¾¿åˆ©ãªã®ã§ä½¿ã£ã¦æ¬²ã—ã„ã¨ã„ã†æ°—æŒã¡ã§æ›¸ãã¾ã—ãŸï¼

https://pkg.go.dev/k8s.io/utils/ptr

# Deref

```go
func Deref[T any](ptr *T, def T) T
```

æ¸¡ã•ã‚ŒãŸ ptr ã® T Pointer ã‚’ Dereference ã— nil ã®å ´åˆã¯ def ã‚’è¿”ã™é–¢æ•°ã§ã™ã€‚

ä¾‹ãˆã° k8s Job ã® suspend ã§å‡¦ç†ã‚’å¤‰æ›´ã—ãŸã„å ´åˆ

```go: ptr.Deref ã‚’ä½¿ç”¨ã—ãªã„
var job batchv1Job
_ := k8sClient.Get(context.BackGround(), client.ObjectKeyFromObject(hoge), &job)
if job.Spec.Suspend != nil && *job.Spec.Suspend {
  // do something when job is suspended.
}
```

`ptr.Deref` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ ä½™è¨ˆãª nil ãƒã‚§ãƒƒã‚¯ãªã©ãŒæ¶ˆãˆç°¡æ½”ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```go: ptr.Deref ã‚’ä½¿ç”¨ã™ã‚‹
var job batchv1.Job
_ := k8sClient.Get(context.BackGround(), client.ObjectKeyFromObject(hoge), &job)
if ptr.Deref(job.Spec.Suspend, false) {
  // do something when job is suspended.
}
```

# To

```go
func To[T any](v T) *T
```

æ¸¡ã•ã‚ŒãŸ v ã® Pointer ã‚’è¿”ã™é–¢æ•°ã§ã™ã€‚

ãã®ã¾ã¾ã§ã™ãŒã€int ã‚„ defined type ã®å ´åˆã¯å‹æŒ‡å®šã§ãã‚‹ã®ã§ã‚ã–ã‚ã–ã‚³ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

```go: ä½™è¨ˆãª Convert ãŒå«ã¾ã‚Œã¦ã„ã‚‹
type Hoge string

pointerInt := ptr.To(int32(10))
pointerDefinedType := ptr.To(Hoge("hoge"))
```

ã§ã¯ãªã

```go
type Hoge string
pointerInt := ptr.To[int32](10)
pointerDefinedType := ptr.To[Hoge]("hoge")
```


# Equal

```go
func Equal[T comparable](a, b *T) bool
```

a ã¨ b ã‚’æ¯”è¼ƒã™ã‚‹é–¢æ•°ã§ã™ã€å¼•æ•°ã« Pointer ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾‹ãˆã° Custom Controller ãªã©ã§å¤ã„ Job ã¨æ–°ãŸãª Job ã® suspend ã‚’æ¯”è¼ƒã—ã¦å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ Condition ã‚’å¤‰ãˆãŸã„å ´åˆ

```go
if !ptr.Equal(oldJob.Spec.Suspend, newJob.Spec.Suspend) {
  // set new condition.
}
```

# AllPtrFieldsNil

```go
func AllPtrFieldsNil(obj interface{}) bool
```

åå‰ã®é€šã‚Šæ§‹é€ ä½“ã®ã™ã¹ã¦ã® Pointer Field ãŒ nil ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°ã§ã™ã€‚

ã»ã¼ä½¿ã†å ´é¢ã¯ãªã„ã¨æ€ã„ã¾ã™ãŒ Default å€¤ã‚’è¨­å®šã—ãŸã„å ´åˆãªã©ã«ä½¿ãˆã¾ã™ã€‚

[å®Ÿéš›ã« Kubernetes ã§ã¯ Volume ã« EmptyDir ã‚’è¨­å®šã™ã‚‹éš›](https://github.com/kubernetes/kubernetes/blob/b15dfce6cbd0d5bbbcd6172cf7e2082f4d31055e/pkg/apis/core/v1/defaults.go#L66-L81)ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

```go
func SetDefaults_Volume(obj *v1.Volume) {
	if ptr.AllPtrFieldsNil(&obj.VolumeSource) {
		obj.VolumeSource = v1.VolumeSource{
			EmptyDir: &v1.EmptyDirVolumeSource{},
		}
	}
	if utilfeature.DefaultFeatureGate.Enabled(features.ImageVolume) && obj.Image != nil && obj.Image.PullPolicy == "" {
		// PullPolicy defaults to Always if :latest tag is specified, or IfNotPresent otherwise.
		_, tag, _, _ := parsers.ParseImageName(obj.Image.Reference)
		if tag == "latest" {
			obj.Image.PullPolicy = v1.PullAlways
		} else {
			obj.Image.PullPolicy = v1.PullIfNotPresent
		}
	}
}
```

# ã¾ã¨ã‚

"k8s.io" ã«ã¯ã„ã‚ã„ã‚ä¾¿åˆ©ãªã‚‚ã®ãŒã‚ã‚‹ã®ã§ãƒ¡ãƒ¢ãŒã¦ã‚‰æ›¸ãç•™ã‚ã‚ˆã†ã¨æ€ã£ã¦æ›¸ãã¾ã—ãŸã€‚

Go ã§ Pointer ã‚’æ“ä½œã—ãŸã„å ´åˆã«ä¾¿åˆ©ãªã®ã§ä½¿ã„ã¾ã—ã‚‡ã†ï¼(2å›ç›®)
